# Retrospective — Epic 5: Outbound Calling, Identity & Dynamic Greeting

**Date:** 2026-02-26
**Scope:** Epic 5 — Stories 5.1–5.7 (all done)
**Facilitator:** Bob (Scrum Master)
**Participants:** Hue (Project Lead), Charlie (Dev), Alice (PO), Dana (QA), Elena (Junior Dev)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Total stories | 7/7 (100%) |
| Tests at epic start | 306 (107 CLI + 111 voice-app + 88 plugin) |
| Tests at epic end | 418 (107 CLI + 126 voice-app + 185 plugin) |
| New tests added | +112 |
| Lint errors | 0 |
| Production incidents | 0 |
| Blockers | 0 |
| Deployment | Pending (critical path item from this retro) |

**Stories delivered:**

| Story | Title | Tests Added |
|-------|-------|-------------|
| 5.1 | Plugin-Triggered Outbound Calls | +16 |
| 5.2 | Dynamic Identity Enrollment | +31 |
| 5.3 | Dynamic Greeting & Call Continuity | +15 |
| 5.4 | Agent Tools & SKILL.md | +11 |
| 5.5 | Persistent Per-Identity Session Context | +27 |
| 5.6 | Identity Resolution for Outbound Callbacks | +13 |
| 5.7 | Cross-Channel Response Delivery | +11 (final: 418) |

**FRs delivered:** FR18, FR19, FR20, FR30, FR32, FR33, FR34, FR35, FR36

---

## What Went Well

### 1. Snowball Architecture — Each Story Made the Next One Easier

Stories 5.1 and 5.2 built the outbound client and identity module respectively. Stories 5.4–5.7 composed directly on top of those primitives. `resolveIdentity()`, `resolveCallbackNumber()`, and `resolveUserChannels()` all follow the same two-source lookup pattern (plugin config first, session config fallback) — consistent, predictable, extensible.

### 2. Story 5.5 Was High-Impact, Low-Complexity

Persistent per-identity session context — the biggest user-facing capability in the epic — was a ~15-line change in `queryAgent`. The key insight: `runEmbeddedPiAgent` already reads session files on startup. Renaming the file from callId-keyed to identity-keyed was all that was needed. Zero API changes, zero new dependencies.

### 3. Epic 4 Preparation Paid in Full

All 5 critical path P-tasks executed before Epic 5 started. The reshaped epic plan (Stories 5.2, 5.3, 5.4 substantially expanded, 5.5–5.7 added) proved accurate. Zero mid-epic surprises.

### 4. Test Discipline — 112 New Tests, Green Throughout

Every story tracked running test count in completion notes. No story shipped with a failing suite. Plugin tests more than doubled (88 → 185).

### 5. "Verify Before Specifying" Held for the Entire Epic

- Story 5.1: No `axios` in plugin — verified, used Node.js built-in `http` instead
- Story 5.3: Hold music reuse verified — `loopHoldMusic()` pattern copied directly from Story 4.3
- Story 5.5: `runEmbeddedPiAgent` session file behavior verified before changing session key logic

### 6. Six Out of Seven Stories Had Zero Debug Incidents

Only Story 5.3 required debugging (test hangs from missing `skipGreeting: true` in existing tests after greeting became dynamic). Stories 5.2, 5.4, 5.5, 5.6, 5.7: "None — clean implementation."

---

## What Didn't Go Well

### 1. Story 5.3 — Downstream Tests Broke Non-Obviously

Replacing the hardcoded greeting with a dynamic bridge query caused two existing test files (`hold-music-unavailability.test.js`, `abort-on-hangup.test.js`) to hang silently. The new greeting code hit never-resolving bridge mocks. Worse: the abort tests were vacuously passing — `triggerHangup()` fired during the greeting query instead of the main-loop query, so tests were green but validating nothing.

**Root cause:** Foundational behavior change (how conversations start) without auditing downstream tests for the assumption it replaced.

**Fix:** Add `skipGreeting: true` to all existing `runConversationLoop` calls in test files that predate Story 5.3.

### 2. Dev Notes Assumed `axios` Was Available (It Wasn't)

Story 5.1 dev notes said "Use `axios` — already a dependency... verify; if not, use Node.js built-in `http`." The fallback was handled, but the primary assumption was wrong. A pre-story dependency check would have been cleaner.

### 3. Dead Code Slipped Through Story 5.1

`plugin.placeCall` stub was attached to the plugin object as "Prepared for Story 5.4" but Story 5.4's tool registration didn't use it. Caught and removed in Story 5.4 code review — but ideally not created in the first place.

### 4. Deployment Was Never Part of Definition of Done

All 7 stories shipped code to the repo. Neither vitalpbx-server nor openclaw-gateway received updates during the epic. Deployment was implicit, not tracked.

---

## Key Insights & Lessons Learned

### Lesson 1: Foundational Changes Need Downstream Test Audits

When you change how something fundamental works (greeting, session naming, bridge return type), explicitly search for all tests that call the changed code and verify their assumptions still hold. Silent hangs and vacuous passes are worse than failures.

### Lesson 2: Deploy First, Document Second

Theoretical deployment steps are worse than none. The actual deployment of Epic 5 will produce the canonical template for future story deployment sections.

### Lesson 3: The Identity Module Is the Right Extensibility Point

Three functions, one module, one consistent pattern. If a new capability needs to know something about a caller's identity or channels, it belongs in `identity.js`.

### Lesson 4: Snowball Architecture Requires Strong Foundations

The reason Stories 5.4–5.7 were fast is that Stories 5.1–5.2 were thorough. Don't rush foundational stories to get to the "exciting" ones.

---

## Previous Retrospective Follow-Through (Epic 4)

| Item | Status | Notes |
|------|--------|-------|
| T4: Update `architecture.md` bridge contract | ✅ Completed | Done as P3 critical path task |
| T5: Fix ESLint globals — full Node.js set | ✅ Completed | No globals issues in entire Epic 5 |
| T6: Migrate `console.log` in `sip-handler.js` | ✅ Completed | Fixed during this retrospective |
| T3: Story 3.2 doc artifact | ✅ Completed | Fixed during this retrospective |
| P1: Reshape Epic 5 stories in epics.md | ✅ Completed | 3 → 7 stories, dynamic greeting + enrollment added |
| P2: Update prd.md with FR30–FR36 | ✅ Completed | All new FRs documented |
| P3: Update architecture.md | ✅ Completed | Identity enrollment + dynamic greeting design added |
| P4: Spike api.registerTool() | ✅ Completed | Worked correctly in Stories 5.2 and 5.4 |
| P5: Spike writeConfigFile() race condition | ✅ Completed | Enrollment mutex implemented in Story 5.2 |
| Agreement: Bridge contract → architecture.md same PR | ⏳ Untested | No bridge contract changes in Epic 5 |
| Agreement: No real infra identifiers | ✅ Held | All stories use canonical names |
| Agreement: Verify before specifying | ✅ Held | Applied in Stories 5.1, 5.3, 5.5 |
| Agreement: allowFrom is the complete model | ✅ Held | No new access control added |

**Result: 9/9 action items completed (or resolved). 2 deferred items (T3, T6) closed during this retro.**

---

## Action Items

### Process

| # | Item | Owner | When |
|---|------|-------|------|
| D1 | Deploy Epic 5 to vitalpbx-server (voice-app Docker rebuild) | Hue | Now |
| D2 | Deploy Epic 5 to openclaw-gateway (git pull + plugin reload) | Hue | Now |
| D3 | Document actual deployment steps taken → add as Deployment section template for future stories | Hue | After D1/D2 |

### Technical Debt

*Debt backlog: empty. T3 and T6 closed during this retrospective.*

### New Team Agreement

6. **Deploy first, document second** — deployment steps written from actual runs, not theory. Deployment + smoke test are part of definition of done going forward.

### Carried Forward Team Agreements

1. No real infrastructure identifiers in committed files ✅
2. Verify before specifying — spike first, dev notes second ✅
3. `allowFrom` is the complete access control model ✅
4. Bridge interface changes → update `architecture.md` in the same PR ✅
5. When foundational behavior changes, audit all downstream tests for broken assumptions ✅ (new from Story 5.3)
6. Deploy first, document second ✅ (new from this retro)

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 418/418 passing, 0 lint errors |
| Deployment | ⚠️ Pending — critical path item D1/D2 |
| Stakeholder Acceptance | ✅ Confirmed (Hue) |
| Technical Health | ✅ Clean — debt backlog empty after T3/T6 fix |
| Unresolved Blockers | ✅ None |
| Epic 6 Prerequisites | ✅ No Epic 6 defined yet — no blockers |

---

## Commitments

- **Action Items:** 3 (D1/D2/D3 — all deployment)
- **New Team Agreements:** 2 (foundational test audit + deploy first)
- **Debt closed:** T3 + T6 (both fixed during retrospective)

## Next Steps

1. ✅ Save retrospective: `epic-5-retro-2026-02-26.md`
2. ✅ Update sprint-status: `epic-5-retrospective: done`, `epic-5: done`
3. Deploy to vitalpbx-server (D1)
4. Deploy to openclaw-gateway (D2)
5. Document deployment steps (D3) → becomes story template

---

*Retrospective facilitated by Bob (Scrum Master). Document generated 2026-02-26.*
