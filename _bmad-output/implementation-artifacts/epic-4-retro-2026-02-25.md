# Retrospective — Epic 4: Call Quality & Session Lifecycle
**Date:** 2026-02-25
**Scope:** Epic 4 (Call Quality & Session Lifecycle) — Stories 4.1, 4.2, 4.3, 4.4
**Facilitator:** Bob (Scrum Master)
**Participants:** Hue (Project Lead), Amelia (Dev), Quinn (QA), Winston (Architect)

---

## Epic Summary

### Epic 4: Call Quality & Session Lifecycle
**Stories:** 4.1 (Independent Session Lifecycle), 4.2 (In-Flight Query Abort on Hangup), 4.3 (Hold Music & Unavailability Message), 4.4 (Plugin Lifecycle & PII-Safe Logging) — all done

| Metric | Value |
|--------|-------|
| Total stories | 4/4 (100%) |
| Tests at epic start | 231 (107 CLI + 39 voice-app + 85 plugin) |
| Tests at epic end | 306 (107 CLI + 111 voice-app + 88 plugin) |
| New tests added | +75 |
| Lint errors | 0 (10 pre-existing brownfield warnings) |
| Production incidents | 0 |
| Blockers | 0 |
| Deployment | Live on vitalpbx-server + openclaw-gateway |

---

## What Went Well

### 1. Story 4.1 Consolidation Was a Force Multiplier

The inbound path in `sip-handler.js` had a 170-line duplicated inline `conversationLoop()` with no `dialog.on('destroy')` listener. Story 4.1 removed it entirely and delegated to `runConversationLoop()` — the same function used by outbound calls. This unified hangup detection, cleanup, and session teardown into one path.

The payoff was immediate: every subsequent Epic 4 story (abort, hold music, PII) had one place to change instead of two.

### 2. AbortController Chain — NFR-R5 from 30s to <1s

Story 4.2 wired `AbortController` through the full chain: `dialog.on('destroy')` → `abortController.abort()` → bridge's axios call. Without this, a caller hanging up mid-query would leave the system waiting up to 30 seconds for an axios timeout. With it, cleanup completes in under a second.

### 3. `loopHoldMusic()` Pattern — Elegant Race-Safe Design

Story 4.3 replaced fire-and-forget hold music with a recursive `loopHoldMusic()` pattern. The key insight: set `musicPlaying = false` BEFORE calling `uuid_break`. This prevents the recursive call from re-starting the loop after the break resolves. The same flag handles the abort (hangup) path — no coordination needed between the two exit paths.

Hue called this out as the highlight of the epic.

### 4. "Verify Before Specifying" Prevented Wasted Work — Twice

- **Story 4.2**: Dev notes analyzed drachtio BYE + axios abort interaction before coding. Changed the approach.
- **Story 4.3**: Checked the brownfield hold music implementation before touching anything. Discovered the architecture spec said "SIP re-INVITE" but the codebase uses `endpoint.play()` into the RTP stream. Correctly diverged from the spec — SIP re-INVITE not implemented. Saved significant complexity.

### 5. Adversarial Code Reviews Consistently Valuable

19 findings across 4 stories:
- 4.2 (7 findings): Race window in AbortController creation, dtmfOff assertion missing, hold music not stopped on abort path, outbound prime query not wired to AbortController, canonical `axios.isCancel()` check, dead code removal, file list artifact
- 4.3 (7 findings): isAvailable check moved before connectCaller (SIP 480 on rejection), loop continuation test added, JSDoc return type fixes, explicit 503 handler in claude-bridge, null guard in conversation-loop, static volume mount to docker-compose + CLI template
- 4.4 (5 findings): `isGoodbye()` word-boundary regex fix, `callerId` removed from `handleInvite()` return object (latent PII risk), dev notes corrections, brownfield console.log tech debt documented

### 6. Previous Retro Commitments Followed Through (5/7)

| Item | Status |
|------|--------|
| P4: Question every config field | ✅ Applied |
| P5: Scope CLI work separately | ✅ Applied — zero CLI scope creep in Epic 4 |
| T2: `_server` eslint-disable | ✅ Resolved in Story 4.4 |
| Verify before specifying | ✅ Applied twice (4.2 and 4.3) |
| No real infra identifiers | ✅ Held across all story files |

---

## What Didn't Go Well

### 1. Bridge Interface Contract Changed Without Updating Architecture Doc

Story 4.3 changed the bridge return type from `{ response: string }` to `{ response: string, isError: boolean }`. This was the right change — necessary to distinguish error responses from real agent replies in the conversation loop. But `architecture.md`'s Bridge Interface Contract section was not updated. The architecture doc now describes a stale contract.

Four test files needed updating when the return type changed (`abort-on-hangup.test.js`, `accountid-flow.test.js`, `session-lifecycle.test.js`, `openclaw-bridge.test.js`).

**Root cause:** No team agreement to update architecture.md alongside bridge interface changes.

**Resolution:** T4 action item + new team agreement: when bridge interface contracts change, update architecture.md in the same PR.

### 2. ESLint Globals Needed Updating Twice

Story 4.2 added `AbortController`/`AbortSignal` globals. Story 4.3 added `setImmediate`/`clearImmediate`. Both are Node.js built-ins that ESLint didn't know about. Minor friction, but it came up twice in one epic.

**Resolution:** T5 — switch to full Node.js globals set in ESLint config.

### 3. Brownfield `console.log` Inconsistency Remains in sip-handler.js

Lines 81, 83, 114, 121, 125 use raw `console.log` instead of the structured logger. None contain PII. Low priority, but inconsistent with the rest of the codebase.

**Resolution:** T6 — deferred migration, low priority.

---

## Key Insights & Lessons Learned

### Lesson 1: Consolidation Is a Force Multiplier

When you see duplicated code with diverging behavior, consolidate it. The 4.1 refactor paid dividends for the next 3 stories — one code path means one place to fix, one place to test, one place to review.

### Lesson 2: Verify Before Specifying Pays Every Time

Applied twice in one epic, changed the approach both times. This habit from Epic 3's retro is now producing consistent returns. Codify it: before writing dev notes for anything that touches brownfield code or an external API, look at the actual code first.

### Lesson 3: Bridge Interface Changes Have Outsized Ripple Effects

Even a non-breaking additive change (`isError` field) touched 4 test files. Mandatory contract changes need to travel with architecture doc updates in the same commit.

### Lesson 4: Architecture Specs Drift From Reality — Actively Maintain Them

This epic produced a significant planning insight: the retrospective discussion surfaced that Epic 5's original spec missed two entire capabilities (dynamic greeting, identity enrollment). The retrospective is the right place to catch this — and acting on it before Epic 5 starts prevents mid-epic surprises.

---

## Previous Retrospective Follow-Through (Epic 3)

| Action Item | Status | Notes |
|-------------|--------|-------|
| P4: Question every config field | ✅ Applied | No unnecessary config fields in Epic 4 |
| P5: Scope CLI work separately | ✅ Applied | Zero CLI scope creep |
| T2: `_server` eslint-disable | ✅ Resolved | Story 4.4, service stop graceful and idempotent |
| T3: Story 3.2 doc artifact | ⏳ Deferred | Very low priority, no code impact |
| Team agreement: no real infra identifiers | ✅ Held | All story files use canonical names |
| Team agreement: verify before specifying | ✅ Held | Applied in 4.2 and 4.3 |
| Team agreement: allowFrom is the complete model | ✅ Held | No new access control abstractions |

---

## Epic 5 Preview & Significant Discoveries

### SIGNIFICANT DISCOVERY: Epic 5 Requires Replanning

The retrospective discussion surfaced two capabilities missing from Epic 5's original spec that are essential to the vision:

**Discovery 1: Dynamic Identity Enrollment**
Epic 5's Story 5.2 assumed static `identityLinks` config (operator pre-configures in `openclaw.json`). Research into the OpenClaw vendor source revealed:
- `api.runtime.config.writeConfigFile()` enables runtime config mutation
- The plugin can dynamically add `session.identityLinks` entries after a first-call enrollment conversation
- A `link_identity` tool can be registered via `api.registerTool()` so the agent can call it directly

**Discovery 2: Dynamic Greeting + Call Continuity**
The current voice-app has a hardcoded greeting: `"Hello! I'm your server. How can I help you today?"` in `conversation-loop.js` line 206. OpenClaw has zero input into the opening of every call.

The fix: replace the hardcoded greeting with an initial bridge query. Hold music plays (same `loopHoldMusic()` pattern from Story 4.3) while the agent generates a greeting. 2–4 seconds, then the agent speaks.

Combined with identity linking, this enables:

| Call type | Agent behavior |
|---|---|
| Unknown caller (not in identityLinks) | Introduces itself, runs enrollment, learns caller's name and channels |
| Known caller, returning | "Hey Hue! Last time we were discussing X — want to pick that up?" |
| Known caller, nothing to follow up | "Hey Hue! What can I do for you today?" |

**OpenClaw identity model (researched from vendor source):**
- `session.identityLinks` in `openclaw.json`: maps canonical identity name → array of provider-prefixed peer IDs (`sip-voice:+15551234567`, `discord:987654321`, `telegram:123456789`)
- `resolveLinkedPeerId()` in SDK: checks both raw and channel-scoped candidates, first match wins
- Two separate users sharing one OpenClaw instance: each gets their own canonical identity, separate private sessions per agent
- `allowFrom` in `devices.json` (voice-app side) remains the security gate — dynamic enrollment only runs AFTER the number is already trusted

### Reshaped Epic 5 Plan

| # | Story | Change from original |
|---|-------|---------------------|
| 5.1 | Plugin-Triggered Outbound Calls | Unchanged |
| 5.2 | **Dynamic Identity Enrollment** | Substantially expanded: first-call detection, enrollment conversation, `link_identity` tool, `writeConfigFile()` persistence |
| 5.3 | **Dynamic Greeting + Call Continuity** | NEW: replace hardcoded greeting with initial bridge query; agent greets by name on returning calls, references last conversation |
| 5.4 | **`place_call` + `link_identity` tools + SKILL.md** | Expanded: both tools registered, SKILL.md covers outbound, enrollment, and continuity behavior |
| 5.5 | Cross-Channel Response Delivery | Unchanged, moved to end |

---

## Action Items

### Technical Debt

| # | Item | Owner | Priority | Notes |
|---|------|-------|----------|-------|
| T4 | Update `architecture.md` Bridge Interface Contract — `query()` returns `{ response: string, isError: boolean }` | Charlie (Dev) | **High** — before Epic 5 dev starts |
| T5 | Fix ESLint globals — add full Node.js built-ins set to `eslint.config.js` | Charlie (Dev) | Medium |
| T6 | Migrate brownfield `console.log` calls in `sip-handler.js` (lines 81, 83, 114, 121, 125) to structured logger | Amelia (Dev) | Low |
| T3 | Story 3.2 file list references removed `shouldAllowCaller()` | — | Very Low — doc artifact, deferred |

### Critical Path — Epic 5 Preparation

| # | Task | Owner | Timing |
|---|------|-------|--------|
| P1 | Update `epics.md` — reshape Epic 5 stories | Bob (SM) + Hue | **BLOCKER — before any Epic 5 story creation** |
| P2 | Update `prd.md` — add new FRs for dynamic greeting, identity enrollment, call continuity, `link_identity` | Alice (PO) + Hue | **BLOCKER** |
| P3 | Update `architecture.md` — bridge interface contract + identity enrollment design + dynamic greeting design | Winston (Architect) | **BLOCKER** |
| P4 | Spike: verify `api.registerTool()` against live OpenClaw SDK before writing Story 5.3/5.4 dev notes | Charlie (Dev) | Before Story 5.3/5.4 dev notes |
| P5 | Spike: verify `api.runtime.config.writeConfigFile()` race condition behavior under concurrent enrollment | Charlie (Dev) | Before Story 5.2 dev notes |

### New Team Agreement

4. **When bridge interface contracts change, update `architecture.md` in the same PR** (new — from this epic)

### Carried Forward Team Agreements

1. No real infrastructure identifiers in committed files ✅
2. Verify before specifying — spike first, dev notes second ✅
3. The only access rule is allow/reject — `allowFrom` is the complete model ✅

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 306/306 passing, 0 lint errors |
| Deployment | ✅ Live on vitalpbx-server + openclaw-gateway |
| Stakeholder Acceptance | ✅ Confirmed (Hue) |
| Technical Health | ✅ Clean — 4 deferred debt items (T3–T6), none blocking |
| Unresolved Blockers | ✅ None |
| Epic 5 Prerequisites | ⚠️ P1/P2/P3 (planning artifact updates) required before Epic 5 can start |

---

## Commitments

**Technical Debt:** 4 items (T3–T6, none blocking)
**Preparation Tasks:** 5 (P1–P5, P1/P2/P3 are critical path)
**New Team Agreement:** 1 (architecture doc sync on bridge interface changes)

## Next Steps

1. ✅ Update sprint-status: `epic-4-retrospective: done`
2. Execute P1/P2/P3 immediately (Hue has directed this): update `epics.md`, `prd.md`, `architecture.md`
3. Apply T4 + T5 before Epic 5 dev starts
4. P4/P5 spikes before Story 5.2/5.3/5.4 dev notes are written

---

*Retrospective facilitated by Bob (Scrum Master). Document generated 2026-02-25.*
