# Retrospective â€” Epic 3: Caller Access Control
**Date:** 2026-02-25
**Scope:** Epic 3 (Caller Access Control) â€” Stories 3.1, 3.2
**Facilitator:** Bob (Scrum Master)
**Participants:** Hue (Project Lead), Amelia (Dev), Quinn (QA), Winston (Architect)

---

## Epic Summary

### Epic 3: Caller Access Control
**Stories:** 3.1 (Caller Allowlist Validation), 3.2 (Unknown Caller Rejection) â€” all done

| Metric | Value |
|--------|-------|
| Total stories | 2/2 (100%) |
| Tests at epic start | 225 (101 cli + 39 voice-app + 85 plugin) |
| Tests at epic end | 231 (107 cli + 39 voice-app + 85 plugin) |
| Lint errors | 0 |
| New dependency | `libphonenumber-js` (CLI) |
| Core implementation | `checkAllowFrom()` â€” 15 lines in `conversation-loop.js` |

---

## What Went Well

### 1. Simplification â€” The Only Access Rule Is Allow/Reject

The entire caller access control model reduces to one decision: is this caller in the list? If yes â€” proceed. If no â€” silent hangup. `allowFrom` empty/missing means no list, so all callers proceed.

Story 3.2 was originally scoped with a `dmPolicy` field (three modes: `allowlist`, `pairing`, `open`) and a `shouldAllowCaller()` wrapper function. Code review caught that the entire concept was redundant. We shipped zero unnecessary abstractions.

### 2. Story 3.2 Scope Discipline

Small story, did exactly what it said. `checkAllowFrom()` from 3.1 was sufficient on its own. The simplification happened during the story, not before it â€” the spec had `dmPolicy` in it. We only cut it when we looked at the actual implementation and asked "what does this add?"

### 3. PII Logging Verified in Tests

Phone numbers are not just claimed to be absent from INFO logs â€” the test suite *asserts it*. Regression is impossible without a failing test. Pattern from the Epics 1+2 retro applied correctly.

### 4. Previous Retro Lessons Applied

- **P2 (Canonical naming):** Story files use `vitalpbx-server`, `openclaw-gateway`, `morpheus`, `cephanie` throughout â€” no real infrastructure identifiers committed.
- **peerId wired (prep from Epics 1+2 retro):** `allowFrom` check had full caller ID available from day one of Epic 3. No blocker.

---

## What Didn't Go Well

### 1. Story 3.1 Scope Expansion

The core implementation is ~15 lines in `conversation-loop.js`. Story 3.1 also included: `parseAllowFrom()` in validators, `libphonenumber-js` integration, `claude-phone device add` allowFrom prompt, `setupDevice()` allowFrom prompt, `region.defaultCountry` setup wizard, E.164 normalization, and 6 new CLI tests.

These additions are useful, but they represent a story that grew well beyond its stated scope. The CLI work arguably belongs in a separate story.

### 2. Test Baseline Staleness

Story 3.1 was written with a baseline of 212 tests. Actual baseline at execution time was 225 â€” a 13-test gap from intervening work between story-write and story-execution. The baseline number in the story became noise.

### 3. Story 3.2 File List / Completion Notes Discrepancy

Story 3.2's File List references `shouldAllowCaller()` as added and exported. The Completion Notes and Change Log clarify it was removed after code review. The code is clean; the story record has a minor doc artifact from the mid-story pivot.

---

## Key Insights & Lessons Learned

### Lesson 1: The Simplest Model That Works Is the Right Model

> "We almost shipped a three-mode policy system to express a boolean." â€” Winston (Architect)

When a config field is proposed to control behavior that already has a natural default (empty = unrestricted), question whether the field is needed at all before writing it into the spec. The right question is: "what does this add?" not "how do we configure this?"

**Action:** Before specifying a new config field or policy mode, write the implementation first mentally â€” if the behavior is already expressible without the field, remove it from the story.

### Lesson 2: Story Scope Creep Is Harder to Catch in CLI Work

The voice-app core (15 lines) was right-sized. The CLI additions that came along for the ride (normalization, regional settings, prompts) were useful but untargeted. CLI UX improvements are easy to bundle in because they "feel related" â€” but they expand story size silently.

### Lesson 3: Test Baselines Degrade Between Story-Write and Story-Execution

Baseline test counts in Dev Notes are accurate at write time, wrong at execution time when stories are written ahead. Either update baselines at execution time or treat them as approximate minimums, not exact numbers.

---

## Previous Retrospective Follow-Through (Epics 1+2)

| Action Item | Status | Notes |
|-------------|--------|-------|
| P1: SDK verification spike first | N/A | Epic 3 had no new external API integrations |
| P2: Canonical naming policy | âœ… Applied | Story files use canonical names throughout |
| P3: Port as security decision | N/A | No new service ports in Epic 3 |
| T1: Story 1.1 dev notes (pre-deployment incorrect API spec) | âœ… Still valid | Historical record, no code impact |
| T2: `_server` eslint-disable | ðŸ”„ Deferred | Story 4.4 resolves this â€” still on track |
| Team agreement: no real infra identifiers in committed files | âœ… Held | Verified across both story files |
| Team agreement: verify before specifying | âœ… Held | Epic 3 had no new external integrations to verify |

---

## Epic 4 Preview & Dependencies

### Epic 4: Call Quality & Session Lifecycle
**Stories:** 4.1 (Independent Session Lifecycle), 4.2 (In-Flight Query Abort), 4.3 (Hold Music & Unavailability), 4.4 (Plugin Lifecycle & PII-Safe Logging)

### Dependencies from Epic 3

| Dependency | Status |
|------------|--------|
| `checkAllowFrom()` and allowlist enforcement in `conversation-loop.js` | âœ… Done |
| PII logging pattern (caller phone at DEBUG only) | âœ… Done â€” tested |
| `_server` eslint-disable carryover (T2) | âœ… Resolves in Story 4.4 |

### Technical Notes for Epic 4

- **Story 4.2 (In-Flight Query Abort):** Verify how drachtio BYE signals interact with a pending axios call before writing Dev Notes. P1 applies â€” spike first.
- **Story 4.4:** Resolves T2 (`_server` eslint-disable for graceful shutdown). Clean slate on that debt item.

### Critical Path Before Epic 4
None â€” no blockers from Epic 3.

---

## Action Items

### Process Improvements

| # | Action | Owner | Timing |
|---|--------|-------|--------|
| P4 | **Question every config field** â€” before specifying a new policy field or mode, check if the natural default already covers the behavior. Write the implementation mentally first. | Dev agent / Architect | Story creation |
| P5 | **Scope CLI work separately** â€” CLI UX improvements (prompts, normalization, regional settings) should be called out explicitly in story scope, not bundled silently with voice-app core changes | SM | Story creation |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| T2 | `_server` eslint-disable in `index.js` | Low | Resolves in Story 4.4 (graceful shutdown) |
| T3 | Story 3.2 file list references removed `shouldAllowCaller()` | Very Low | Doc artifact only â€” code is correct; update story record if convenient |

### Team Agreements (Carried Forward + New)

1. **No real infrastructure identifiers in committed files** (from Epics 1+2 retro â€” holding)
2. **Verify before specifying** â€” spike against live system before writing Dev Notes for any new external API (from Epics 1+2 retro â€” holding; applies to Story 4.2 BYE/axios interaction)
3. **The only access rule is allow/reject** â€” `allowFrom` is the complete model; no dmPolicy, no modes, no wrappers (new)

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | âœ… 231/231 passing, 0 lint errors |
| Deployment | âœ… Caller access control live (vitalpbx-server) |
| PII & Security | âœ… Phone numbers at DEBUG only, verified in test suite |
| Epic 4 Prerequisites | âœ… No blockers â€” checkAllowFrom in place, peerId wired, PII patterns set |
| Technical Health | âœ… Clean â€” 2 minor deferred debt items (T2, T3), neither blocking |

---

## Commitments

**Action Items:** 2 new process improvements (P4, P5)
**Technical Debt:** 1 deferred (T2 â†’ resolves in 4.4), 1 trivial (T3)
**Critical Path Before Epic 4:** None

## Next Steps

1. Update sprint-status: `epic-3-retrospective: done`
2. Begin Epic 4 â€” Story 4.1 (Independent Session Lifecycle) is unblocked
3. Apply P1 at the start of Story 4.2 â€” spike on drachtio BYE + axios abort before Dev Notes
4. Review P4/P5 at start of Epic 4 story creation

---

*Retrospective facilitated by Bob (Scrum Master). Document generated 2026-02-25.*
