# Retrospective — Epics 1 & 2 Combined
**Date:** 2026-02-24
**Scope:** Epic 1 (Inbound Call to OpenClaw Agent) + Epic 2 (Multi-Agent Routing & Configuration)
**Facilitator:** Bob (Scrum Master)
**Participants:** Hue (Project Lead), Amelia (Dev), Quinn (QA), Winston (Architect), Paige (Tech Writer)

---

## Epic Summary

### Epic 1: Inbound Call to OpenClaw Agent
**Stories:** 1.1, 1.2, 1.3, 1.4 — all done

### Epic 2: Multi-Agent Routing & Configuration
**Stories:** 2.1, 2.2, 2.3, 2.4 — all done

### Combined Metrics

| Metric | Value |
|--------|-------|
| Total stories | 8/8 (100%) |
| Total tests | 216 (101 cli + 30 voice-app + 85 plugin) |
| Lint errors | 0 |
| Production deployment | ✅ Full end-to-end working |
| Post-deployment rewrites | 1 major (Story 1.1 — complete plugin rewrite) |

---

## What Went Well

### 1. Bridge Pattern — Perfect Drop-In
`openclaw-bridge.js` is a true drop-in for `claude-bridge.js` — identical method names, identical signatures, identical error-handling contract. Voice-app has zero knowledge of which backend it's talking to. `BRIDGE_TYPE=openclaw` is the only change required to switch backends.

### 2. Architecture Proven Sound by Story 2.3
Story 2.3 (Concurrent Session Isolation) required **zero production code changes**. The Map-keyed-by-`callId` design from Stories 1.2/1.3 structurally prevented context bleed between callers. When a whole story's implementation is "nothing to implement," the foundation was right.

### 3. Test Discipline
- Real HTTP test servers on port 0 (no mocking of axios internals)
- Module cache clearing for proper test isolation
- PII discipline **verified in tests** — assertions that `peerId` never appears in INFO/WARN/ERROR logs
- 216 tests, 0 failures at end of both epics

### 4. docs/openclaw-plugin-architecture.md
The reference document created during the deployment recovery is the SDK guide that should have existed before Epic 1. It is now a permanent resource that prevents the same API assumption mistakes in any future plugin work.

### 5. Error Handling Contract
`query()` never throws — it returns friendly strings that get spoken to the caller via TTS. This pattern (inherited from `claude-bridge.js` and replicated faithfully) means network failures degrade gracefully with an audible message rather than dead air.

### 6. Factory Pattern for Express App
`createServer(config)` returns an app without calling `.listen()`. `startServer(app, port)` is a separate step. This enabled clean testing without port binding and set up graceful shutdown for Story 4.4.

---

## What Didn't Go Well

### 1. Wrong API Assumptions in Story 1.1 — Complete Post-Deployment Rewrite

**What happened:** Story 1.1 was implemented, passed all tests, passed code review, and was marked done — then failed completely on first deployment to the openclaw gateway. The entire plugin required a rewrite.

**Wrong assumptions (all in Dev Notes, all propagated into tests):**

| Assumed (Wrong) | Actual (Correct) |
|---|---|
| `async activate(api)` | `register(api)` — synchronous, returns undefined |
| `api.getConfig()` method | `api.pluginConfig` property |
| `api.registerChannel({ id, name })` | `api.registerService({ id, start, stop })` |
| `module.exports = { activate, getConfig }` | `module.exports = plugin` (single object) |
| `plugin.id = 'sip-voice'` | Must match `plugins.entries` key in openclaw.json |
| Logger includes ISO timestamp | journald adds its own — double timestamps in output |
| `package.json "main"` is sufficient | Also need `"openclaw": { "extensions": [...] }` |
| `resolveStorePath(config)` takes config object | `resolveStorePath(store?: string)` takes string |

**Root cause:** Dev Notes were written against inferred/outdated documentation and a referenced `voice-call` extension that apparently reflected an older API shape. No verification was done against a live gateway before writing the spec.

**Impact:** Cascaded into Stories 1.2 and 1.3 (partial rewrites). Recovered same day.

### 2. PII in Documentation Artifacts

**What happened:** Real server hostnames (`hue@192.168.116.x`, `dewey@192.168.116.x`) and internal IP addresses appeared in story records, the deployment retrospective, and sprint status comments — all committed to a public repository.

**Root cause:** PII discipline was applied rigorously to code (peerId at DEBUG only, API keys never logged) but the same discipline was not applied to documentation artifacts. No canonical naming convention existed.

**Caught:** During this retrospective before the branch was pushed.

**Fix applied:** All real hostnames and IPs replaced with canonical names (`vitalpbx-server`, `openclaw-gateway`). Port changed from `3334` to `47334` (less adjacent to claude-api-server port 3333, not in common port scanner lists).

### 3. peerId Not Wired Through Call Chain

**What happened:** Story 2.1 explicitly deferred `peerId` wiring: *"Do NOT pass peerId yet — not in scope."* The bridge handled `peerId` when present (forward-compatible from Story 1.4), but callers in `sip-handler.js` and `conversation-loop.js` never included it.

**Impact:** Epic 3's allowlist validation (`allowFrom` check) needs the caller's phone number. This would have been a blocker at the start of Story 3.1.

**Fix applied:** `peerId` wired in this session. `callerId` now flows from `sip-handler.js` → `conversationLoop()` → `claudeBridge.query()` options. 216/216 tests still passing.

---

## Key Insights & Lessons Learned

### Lesson 1: Verify Before Specifying
Any story whose Dev Notes reference an external API must be preceded by a verification spike against a live system. Assumptions written into Dev Notes become implementation assumptions, which become mock assumptions, which become test assumptions. Wrong at the source = wrong everywhere — including tests that pass confidently.

**Action:** SDK verification spike is the first task for any story integrating a new external API.

### Lesson 2: PII Discipline Applies to Documentation Too
The same rigor applied to log output (no phone numbers at INFO, no API keys ever) must apply to committed documentation. Real hostnames, IP addresses, and credentials do not belong in story records, retrospectives, or planning artifacts.

**Action:** Canonical placeholder names (`vitalpbx-server`, `openclaw-gateway`, `morpheus`, `cephanie`) used from day one in all artifacts. Real values stay in `.env` and `openclaw.json` only.

### Lesson 3: Port Choices Are Security Decisions
Default port numbers in plugin config schemas are committed publicly. `47334` instead of `3334` — less predictable, not adjacent to known ports.

### Lesson 4: Trust Structural Guarantees
Story 2.3 proved the architecture was correct. When a concurrent isolation story requires zero code changes, don't second-guess it — verify it with tests and ship.

### Lesson 5: Forward-Compatibility Pays Off
`openclaw-bridge.js` was built to omit `accountId` and `peerId` when undefined (Story 1.4). Story 2.1 added `accountId` without touching the bridge. `peerId` wiring today (pre-Epic 3) required no bridge changes. Good interface design reduces future story scope.

---

## Previous Retrospective Follow-Through

**N/A — This is the first retrospective.**

---

## Epic 3 Preview & Preparation

### Epic 3: Caller Access Control
**Stories:** 3.1 (Caller Allowlist Validation), 3.2 (Unknown Caller Rejection & DM Policy)

### Dependencies from Epics 1+2

| Dependency | Status |
|---|---|
| `allowFrom` array in `devices.json` | ✅ Brownfield (already exists) |
| `peerId` wired through call chain | ✅ Done in this session |
| `dmPolicy` field in devices | ⚠️ Story 3.2 scope (not yet in devices.json) |

### Preparation Completed This Session
- [x] `peerId` wired: `sip-handler.js` + `conversation-loop.js` → `claudeBridge.query()` options
- [x] 216/216 tests passing after wiring

### Critical Path Before Epic 3
None — `peerId` was the only blocker and it's resolved.

---

## Action Items

### Process Improvements

| # | Action | Owner | Timing |
|---|--------|-------|--------|
| P1 | **SDK verification spike first** — any story integrating a new external API must start with a live-system verification task before Dev Notes are written | Dev agent | Before first story of any new external integration |
| P2 | **Canonical naming policy** — vitalpbx-server, openclaw-gateway, morpheus, cephanie are the public names; real hostnames/IPs stay in .env only | All | From now on |
| P3 | **Port as security decision** — default ports in committed config schemas should be non-obvious; document rationale in schema comments | Architect | When adding new service ports |

### Technical Debt

| # | Item | Priority | Notes |
|---|------|----------|-------|
| T1 | Story 1.1 Dev Notes contain pre-deployment incorrect API spec | Low | Already annotated as WRONG in-file; no code impact; leave as historical record |
| T2 | `_server` eslint-disable in `index.js` | Low | Intentional forward reference for Story 4.4 graceful shutdown; resolve in Epic 4 |

### Team Agreements

1. **No real infrastructure identifiers in committed files** — hostnames, IPs, API keys, and usernames stay in runtime config only
2. **Verify before specifying** — spike against live system before writing Dev Notes for any new external API
3. **peerId is now always available** — all callers pass it; Epic 3 can rely on it

---

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | ✅ 216/216 passing, 0 lint errors |
| Deployment | ✅ End-to-end working (vitalpbx-server + openclaw-gateway) |
| PII & Security | ✅ Cleaned up in this session; port updated to 47334 |
| Epic 3 Prerequisites | ✅ peerId wired, allowFrom exists, no blockers |
| Technical Health | ✅ Clean — 2 minor deferred debt items, neither blocking |

---

## Next Steps

1. **Commit this branch** — PII cleanup, port change (3334→47334), peerId wiring, retro document
2. **Begin Epic 3** — Story 3.1 (Caller Allowlist Validation) is unblocked
3. **Review action items at next standup** — P1 (SDK spike policy) is the most important to embed

---

*Retrospective facilitated by Bob (Scrum Master). Document generated 2026-02-24.*
